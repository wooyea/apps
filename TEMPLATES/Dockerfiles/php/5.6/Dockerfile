FROM debian:jessie

ADD sources.list.jessie /etc/apt/sources.list

# persistent / runtime deps
RUN apt-get update && apt-get install -y ca-certificates curl librecode0 libsqlite3-0 libxml2 --no-install-recommends && rm -r /var/lib/apt/lists/*

# phpize deps
RUN apt-get update && apt-get install -y autoconf file g++ gcc libc-dev make pkg-config re2c --no-install-recommends && rm -r /var/lib/apt/lists/*

ENV PHP_INI_DIR /usr/local/etc/php
RUN mkdir -p $PHP_INI_DIR/conf.d

##<autogenerated>##
RUN apt-get update && apt-get install -y apache2-bin apache2.2-common --no-install-recommends && rm -rf /var/lib/apt/lists/*

RUN rm -rf /var/www/html && mkdir -p /var/lock/apache2 /var/run/apache2 /var/log/apache2 /var/www/html && chown -R www-data:www-data /var/lock/apache2 /var/run/apache2 /var/log/apache2 /var/www/html

# Apache + PHP requires preforking Apache for best results
RUN a2dismod mpm_event && a2enmod mpm_prefork

RUN mv /etc/apache2/apache2.conf /etc/apache2/apache2.conf.dist && rm /etc/apache2/conf-enabled/* /etc/apache2/sites-enabled/*

COPY apache2.conf /etc/apache2/apache2.conf

COPY docker-php-ext-* /usr/local/bin/

COPY $PHP_FILENAME $PHP_FILENAME


ENV PHP_VERSION 5.6.18
ENV PHP_FILENAME php-5.6.18.tar.xz

# --enable-mysqlnd is included below because it's harder to compile after the fact the extensions are (since it's a plugin for several extensions, not an extension in itself)
RUN buildDeps=" \
        apache2-dev \
        libbz2-dev \ 
	libcurl4-openssl-dev \ 
	libenchant-dev \ 
	libfreetype6-dev \ 
	libgmp-dev \ 
	libicu-dev \ 
	libjpeg62-turbo-dev \ 
	libldap2-dev \ 
	libmcrypt-dev \ 
	libpng12-dev \ 
	libpq-dev \ 
	libpspell-dev \ 
	libreadline6-dev \ 
	librecode-dev \ 
	libsnmp-dev \ 
	libsqlite3-dev \ 
	libssl-dev \ 
	libtidy-dev \ 
	libxml2-dev \ 
	libxslt1-dev \
	xz-utils \ 
	" \
	&& set -x \
	&& apt-get update && apt-get install -y $buildDeps --no-install-recommends && rm -rf /var/lib/apt/lists/* \
	&& mkdir -p /usr/src/php \
	&& tar -xf "$PHP_FILENAME" -C /usr/src/php --strip-components=1 \
	&& rm "$PHP_FILENAME"* \
        && mkdir /usr/gmp \
        && ln -s /usr/include/x86_64-linux-gnu /usr/gmp/include \
        && ln -s /usr/lib/x86_64-linux-gnu/ /usr/gmp/lib \
        && mkdir /usr/ldap \
        && ln -s /usr/include /usr/ldap/include \
        && ln -s /usr/lib/x86_64-linux-gnu/ /usr/ldap/lib \
        && mkdir /usr/openssl\
        && ln -s /usr/include /usr/openssl/include \
        && ln -s /usr/lib/x86_64-linux-gnu/ /usr/openssl/lib \
	&& cd /usr/src/php \
	&& ./configure \
		--with-config-file-path="$PHP_INI_DIR" \
		--with-config-file-scan-dir="$PHP_INI_DIR/conf.d" \
		-with-apxs2 \
		--disable-cgi \
		--enable-mysqlnd \
		--with-curl \
		--with-openssl \
		--enable-fpm \
		--with-fpm-user=www-data --with-fpm-group=www-data \
		--with-readline \
		--with-recode \
		--with-zlib \
	&& make -j"$(nproc)" \
	&& make install \
	&& { find /usr/local/bin /usr/local/sbin -type f -executable -exec strip --strip-all '{}' + || true; } \
        && docker-php-ext-configure gd --with-freetype-dir=/usr/include/ --with-jpeg-dir=/usr/include/ \
        && docker-php-ext-configure gmp --with-gmp=/usr/gmp/ \
        && docker-php-ext-configure ldap --with-ldap=/usr/ldap/ \
        && docker-php-ext-install -j$(nproc) bcmath bz2 calendar curl dba enchant exif ftp gd \
        gettext gmp iconv intl ldap mbstring mcrypt mysql mysqli opcache pdo_mysql \
        pdo_pgsql pdo_sqlite pgsql pspell shmop snmp soap sockets sysvmsg \
        sysvsem sysvshm tidy xmlrpc xsl zip  \
	&& dpkg -l | awk '{print $2}' | grep  -E '\-dev$|dev:' | xargs apt-get -y purge \
        && rm -r /var/lib/apt/lists/* \
        && rm -rf /usr/src

# Caution!
# disabled extensions : imap intl pdo_odbc odbc pdo_dblib 
# extension imap - build faild! configure: error: utf8_mime2text() has new signature, but U8T_CANONICAL is missing. 
# extension intl - needs icu


COPY apache2-foreground /usr/local/bin/
WORKDIR /var/www/html

EXPOSE 80
CMD ["apache2-foreground"]
